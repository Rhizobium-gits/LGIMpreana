# 腸内細菌叢動態予測モデル：仕組みと処理の流れ

## 1. 研究の背景と目的

### 1.1 データの特性と課題

本研究で扱うデータは以下の構成を持つ：

- **ドナー**: 3名（D1, D2, D3）
- **重力条件**: 5種類（0g, 1/6g, 1g, 1g_s, 5g）
- **時点**: 3点（8h, 16h, 24h）
- **レプリケート**: 各3回
- **細菌種**: 120属

合計135サンプル、120次元の時系列データである。

このデータには以下の課題がある：

1. **時点数が少ない**: わずか3時点では動態の詳細な推定が困難
2. **サンプル数の制約**: 各条件9サンプルでは統計的検出力が限られる
3. **個人差が大きい**: ドナー間で細菌組成が大きく異なる
4. **高次元性**: 120種の細菌に対してサンプル数が相対的に少ない

このような「扱いにくいデータ」に対して、どこまで予測が可能かを検証した。

### 1.2 予測の目標

**8時間後と16時間後のデータのみを使って学習し、24時間後の細菌組成を予測する。**

24時間後のデータは学習に一切使用せず、純粋な予測精度評価に用いる。

---

## 2. 予測モデルの仕組み

### 2.1 基本的な考え方

腸内細菌叢の変化は、以下の2つの要因で決まると仮定する：

1. **細菌間相互作用**: ある細菌が別の細菌の増殖を促進または抑制する
2. **重力の影響**: 各重力条件が細菌の増殖に与える固有の効果

これら2つを組み合わせて予測を行う「ハイブリッドモデル」を構築した。

### 2.2 Generalized Lotka-Volterra（gLV）モデル

細菌間相互作用を記述するために、生態学で広く使われるgLVモデルを採用した。

```
dx_i/dt = x_i × (r_i + Σ_j A_ij × x_j)
```

**各記号の意味**：
- `x_i`: 細菌iの相対存在量（全体に占める割合、0〜1の値）
- `r_i`: 細菌iの内在的増殖率（他の細菌がいない場合の増殖速度）
- `A_ij`: 細菌jが細菌iに与える影響（相互作用係数）

**相互作用係数 A_ij の解釈**：
- `A_ij > 0`: 細菌jは細菌iの増殖を**促進**する（共生関係）
- `A_ij < 0`: 細菌jは細菌iの増殖を**抑制**する（競争関係）
- `A_ii < 0`: 自己抑制（環境収容力による制限）

このモデルでは、120種 × 120種 = 14,400個の相互作用パラメータを推定する必要がある。

---

## 3. 処理の流れ

### Step 1: データの準備

#### 1-1. 相対存在量への変換

生のリード数を総リード数で割り、各サンプルの総和が1になるよう正規化する。

```
相対存在量 = リード数 / サンプル総リード数
```

例：あるサンプルでBacteroidesが10,000リード、総リード数が50,000の場合
```
Bacteroidesの相対存在量 = 10,000 / 50,000 = 0.20（20%）
```

#### 1-2. 学習データとテストデータの分離

- **学習データ**: 8h, 16hのサンプル（90サンプル）
- **テストデータ**: 24hのサンプル（45サンプル）

24hのデータは学習には一切使用しない。

---

### Step 2: 成長率の計算

連続する時点間での細菌の増減速度を計算する。

```
成長率 = (log(存在量_t2) - log(存在量_t1)) / (t2 - t1)
```

**なぜ対数を取るのか？**

細菌は指数関数的に増殖する。対数を取ることで、指数的な増殖が線形になり、回帰分析が適用できる。

**具体例**：
- 8hでBacteroidesが0.30、16hで0.45の場合
```
成長率 = (log(0.45) - log(0.30)) / 8 = (-0.80 - (-1.20)) / 8 = 0.05 /時間
```

これは「1時間あたり約5%ずつ対数スケールで増加」を意味する。

**収集される遷移データ**：
- 3ドナー × 5重力条件 × 3レプリケート = 45組
- 各組で8h→16hの遷移1つ
- 合計約45遷移（一部は細菌が検出されず除外）

---

### Step 3: gLVパラメータの推定（Ridge回帰）

#### 3-1. 回帰問題への変換

gLVモデルを変形すると、以下の線形回帰問題になる：

```
成長率_i = r_i + A_i1×x_1 + A_i2×x_2 + ... + A_in×x_n
```

これは「成長率を、定数項（内在的増殖率）と各細菌の存在量の線形結合で説明する」という形式。

#### 3-2. Ridge回帰の必要性

通常の最小二乗法では問題が生じる：
- **変数の数（121個）がサンプル数（45個）より多い**
- → 解が一意に定まらない
- → 過学習が起きる

そこで、**Ridge回帰（L2正則化）** を用いる。

```
目的関数 = Σ(予測誤差)² + λ × Σ(パラメータ)²
```

第2項（正則化項）により：
- パラメータが大きくなりすぎるのを防ぐ
- 過学習を抑制する
- 安定した推定が可能になる

本実装では正則化パラメータ **λ = 0.5** を使用。

#### 3-3. パラメータ推定の結果

- 120個の内在的増殖率 r_i
- 120 × 120 = 14,400個の相互作用係数 A_ij

ただし、正則化により多くの係数は0に近い値に縮小される。

---

### Step 4: 重力効果の定量化

gLVモデルだけでは捉えきれない、重力条件固有の効果を別途推定する。

```
重力効果[g][i] = (16h時点の平均存在量 - 8h時点の平均存在量) / 8
```

これは「その重力条件下で、細菌iが1時間あたりどれだけ変化するか」を表す。

**計算例（0g条件のBacteroides）**：
- 8h時点の平均: 0.35
- 16h時点の平均: 0.34
```
重力効果 = (0.34 - 0.35) / 8 = -0.00125 /時間
```

つまり「0g条件では、Bacteroidesは1時間あたり0.125%ずつ減少する傾向がある」。

---

### Step 5: 24時間後の予測

16時間後の観測値から、24時間後を予測する。

#### 5-1. gLVによる変化量の計算

推定した相互作用パラメータを使って、8時間分の変化を計算：

```
gLV変化量_i = x_i(16h) × (r_i + Σ_j A_ij × x_j(16h)) × 8
```

#### 5-2. 重力効果による変化量の計算

その重力条件の経験的トレンドから、8時間分の変化を計算：

```
重力変化量_i = 重力効果[g][i] × 8
```

#### 5-3. ハイブリッド予測

2つの変化量を半分ずつ重み付けして組み合わせる：

```
予測値(24h) = 観測値(16h) + 0.5 × gLV変化量 + 0.5 × 重力変化量
```

**なぜ組み合わせるのか？**

- gLVモデル: 細菌間相互作用を考慮するが、データが少なく不安定
- 重力効果: 経験的トレンドを捉えるが、個別の相互作用は無視

両者を組み合わせることで、より安定した予測を目指す。

#### 5-4. 正規化

予測値を相対存在量として妥当な形に整える：

1. 負の値を0にクリップ
2. 総和が1になるよう正規化

```
最終予測値_i = max(0, 予測値_i) / Σ_j max(0, 予測値_j)
```

---

## 4. 検証結果

### 4.1 全体の精度

45サンプルの予測結果：

| 指標 | 値 | 解釈 |
|------|-----|------|
| 平均RMSE | 0.028 | 平均二乗誤差の平方根 |
| 平均Bray-Curtis | 0.32 | 群集組成の約32%が異なる |
| 平均相関係数 | 0.77 | 予測と実測に中程度の相関 |

### 4.2 ドナー別の精度

| ドナー | Bray-Curtis | 相関係数 |
|--------|-------------|----------|
| D1 | 0.25 | 0.84 |
| D2 | 0.37 | 0.67 |
| D3 | 0.34 | 0.73 |

ドナー1の予測精度が高く、ドナー2は低い。個人差の影響が大きい。

### 4.3 細菌種別の精度

| 細菌種 | 予測値 | 実測値 | バイアス | 相関 |
|--------|--------|--------|----------|------|
| Bacteroides | 0.49 | 0.21 | +0.28 | 0.97 |
| Prevotella | 0.04 | 0.08 | -0.04 | 0.99 |
| Staphylococcus | 0.11 | 0.16 | -0.05 | 0.87 |

Bacteroidesは系統的に過大予測される傾向がある。

---

## 5. 結果の解釈

### 5.1 達成できたこと

- 相関係数0.77：予測と実測にある程度の線形関係がある
- 個別細菌の相関は0.7〜0.99：主要な細菌の増減傾向は捉えている
- 完全なランダム予測よりは明らかに良い

### 5.2 限界

- Bray-Curtis 0.32：群集構造として約3割の差がある
- 実用的な精度としては不十分
- 特にドナー2の予測精度が低い

### 5.3 精度が限られる原因

1. **遷移データが少なすぎる**: 45遷移で14,400パラメータを推定
2. **非線形な動態**: gLVは線形近似であり、真の動態を完全には捉えられない
3. **ドナー間差**: 個人ごとに異なる相互作用パターンがある可能性
4. **相対存在量の制約**: 絶対量でないため、組成的な制約がある

---

## 6. 処理フローのまとめ

```
[入力データ]
    ↓
[Step 1] 相対存在量に変換 & データ分割
    ↓
[Step 2] 成長率の計算（対数変換）
    ↓
[Step 3] Ridge回帰でgLVパラメータ推定
    ↓
[Step 4] 重力効果の計算
    ↓
[Step 5] ハイブリッド予測
    ├── gLV変化量（相互作用効果）
    └── 重力変化量（経験的トレンド）
    ↓
[Step 6] 正規化（負値クリップ、総和=1）
    ↓
[出力] 24h時点の予測組成
```

---

## 7. 結論

限られた時系列データ（3時点、45遷移）から、gLVモデルと重力効果を組み合わせたハイブリッドアプローチにより、相関係数0.77の予測精度を達成した。

これは「完全には予測できないが、全くのランダムでもない」という中間的な結果であり、データの制約を考慮すると妥当な精度である。

今後の改善には、より高頻度のサンプリング、絶対定量の導入、ドナー別モデルの構築などが必要である。
