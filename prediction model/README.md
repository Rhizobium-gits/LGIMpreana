# gLV予測モデルと精度検証

## 概要

本ドキュメントでは、腸内細菌叢の時系列予測モデルの
アルゴリズムと精度検証実験について記述する。

## データの特性と課題

### データ構成
- 3ドナー x 5重力条件 x 3時点 x 3レプリケート = 135サンプル
- 120種の細菌（taxa）
- 時点: 8h, 16h, 24h（培養時間）

### 課題
- 時点数が少ない（3点のみ）
- 各条件のサンプル数が限られている（9サンプル/条件）
- 個人差（ドナー間変動）が大きい
- 高次元（120 taxa）に対してサンプル数が少ない

このような「扱いやすくないデータ」に対して、
どこまで予測が可能かを検証した。


## 予測モデルのアルゴリズム

### 1. Generalized Lotka-Volterra (gLV) モデル

細菌間の相互作用を記述する微分方程式モデル：

```
dx_i/dt = x_i * (r_i + sum_j(A_ij * x_j))
```

- x_i: 細菌iの相対存在量
- r_i: 細菌iの内在的増殖率
- A_ij: 細菌jが細菌iに与える影響（相互作用係数）
  - A_ij > 0: 促進的相互作用
  - A_ij < 0: 抑制的相互作用

### 2. パラメータ推定

時系列データから成長率を計算：

```
d(log x_i)/dt ≈ (log x_i(t2) - log x_i(t1)) / (t2 - t1)
```

これを目的変数として、以下の回帰問題を解く：

```
d(log x_i)/dt = r_i + sum_j(A_ij * x_j)
```

Ridge回帰（L2正則化）でパラメータを推定：
- 正則化項 lambda = 0.5
- 過学習を抑制し、安定した推定を得る

### 3. 重力効果の定量化

各重力条件について、8h→16hの変化率を計算：

```
gravity_effect[g][i] = (mean_abundance_16h - mean_abundance_8h) / 8
```

これにより、重力条件ごとの細菌の増減傾向を捉える。

### 4. 予測の計算

16hの状態から24hを予測：

```
x_pred(24h) = x(16h) + 0.5 * glv_change + 0.5 * gravity_change
```

- glv_change: gLVモデルによる相互作用効果
- gravity_change: 重力特異的なトレンド

両者を組み合わせることで、より安定した予測を目指した。


## 精度検証実験

### 実験設計

データ分割：
- 学習データ: 8h, 16hのサンプル（90サンプル）
- テストデータ: 24hのサンプル（45サンプル）

24hのデータは学習に一切使用せず、純粋な予測精度評価に用いた。

### 評価指標

1. RMSE (Root Mean Square Error)
   - 予測誤差の二乗平均平方根
   - 小さいほど良い

2. MAE (Mean Absolute Error)
   - 予測誤差の絶対値平均
   - 小さいほど良い

3. Bray-Curtis距離
   - 群集組成の非類似度
   - 0: 完全一致、1: 完全不一致
   - 0.3未満が望ましい

4. Pearson相関係数
   - 予測値と実測値の線形相関
   - 1に近いほど良い


## 検証結果

### 条件別の予測精度

```
Condition       N          RMSE       MAE        Bray-Curtis
-------------------------------------------------------
D1_0g           3         0.0236     0.0043     0.2598
D1_1_6g         3         0.0201     0.0038     0.2307
D1_1g           3         0.0212     0.0040     0.2410
D1_1g_s         3         0.0297     0.0054     0.3226
D1_5g           3         0.0153     0.0030     0.1794
D2_0g           3         0.0329     0.0061     0.3630
D2_1_6g         3         0.0336     0.0063     0.3755
D2_1g           3         0.0342     0.0063     0.3778
D2_1g_s         3         0.0329     0.0061     0.3675
D2_5g           3         0.0334     0.0061     0.3653
D3_0g           3         0.0274     0.0054     0.3267
D3_1_6g         3         0.0261     0.0053     0.3208
D3_1g           3         0.0278     0.0056     0.3369
D3_1g_s         3         0.0304     0.0058     0.3465
D3_5g           3         0.0290     0.0059     0.3552
```

### 全体統計

```
Overall statistics (N=45 predictions):
  Mean RMSE:         0.0278
  Mean Bray-Curtis:  0.3179
  Mean Correlation:  0.7713
```

### 細菌別の予測精度（上位15種）

```
Taxon                Mean Pred    Mean Actual  Diff         Corr
--------------------------------------------------------------------
Bacteroides           0.4855       0.2089       0.2766       0.9652
Prevotella            0.0444       0.0818      -0.0374       0.9885
Staphylococcus        0.1113       0.1624      -0.0511       0.8732
Blautia               0.0266       0.0427      -0.0161       0.7126
Pseudomonas           0.0519       0.0827      -0.0308       0.9763
Escherichia_Shigella  0.0324       0.0577      -0.0253       0.8237
Faecalibacterium      0.0036       0.0102      -0.0065       0.8364
Acinetobacter         0.0322       0.0424      -0.0102       0.8874
Streptococcus         0.0199       0.0376      -0.0177       0.8292
Veillonella           0.0118       0.0230      -0.0112       0.9686
```


## 結果の解釈

### 良い点

1. 相関係数は全体で0.77と、ある程度の予測能力を示した
2. 個別の細菌については0.8-0.98の高い相関を示すものが多い
3. ドナー1の予測精度が相対的に高い（Bray-Curtis 0.18-0.32）

### 課題

1. Bray-Curtis距離が平均0.32と、完全な予測には程遠い
2. Bacteroidesで予測値と実測値に大きな乖離（+0.28）
3. ドナー2の予測精度が低い（Bray-Curtis 0.36-0.38）
4. 多くの細菌で24hの存在量を過小評価する傾向

### 原因の考察

1. 学習データの遷移数が45と少なく、120次元の相互作用行列を
   十分に推定できていない可能性

2. 8h-16hの変化パターンが16h-24hでは異なる可能性
   （非線形な動態）

3. ドナー間の個人差が大きく、ドナー共通のパラメータでは
   一部のドナーに対する予測が困難

4. gLVモデルの仮定（二体相互作用のみ）が
   実際の複雑な細菌間関係を捉えきれていない


## 今後の改善案

1. より長い時系列データの取得
2. サンプリング間隔の短縮（より多くの遷移データ）
3. ドナー別のモデル構築
4. 次元削減（主要な細菌のみでモデリング）
5. より柔軟なモデル（ニューラルネットワーク等）の検討


## 結論

限られたデータ（3時点、45遷移）という制約の中で、
相関係数0.77の予測精度を達成した。

これは「予測が全くできない」わけではないが、
「実用的な予測」には更なるデータとモデルの改善が必要であることを示す。

特にBray-Curtis距離0.32は、群集構造として約3割の違いがあることを意味し、
精密な予測が求められる応用には不十分である。

本検証は、現状のデータとモデルの限界を正直に示したものであり、
今後の研究の方向性を検討する材料となる。
